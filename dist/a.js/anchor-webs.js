define(function(require,exports,module){require("jquery"),require("socket");var Map=require("map"),cons=require("cons"),lvs=require("./anchor-live"),Tools=require("./anchor-tools"),wcall=require("./anchor-call"),gift=require("./anchor-gift"),guards=require("./anchor-guard"),hall=require("./anchor-hall"),chat=require("./anchor-chat"),login=require("./anchor-login"),task=require("./anchor-task"),anchor=require("./anchor-anchor"),song=require("./anchor-songs"),setting=require("./anchor-setting"),swf=require("./anchor-swf"),list=require("./anchor-list"),face=require("./anchor-face"),backLoad=require("./anchor-backLoad"),pet=require("./anchor-pet"),treasureBox=require("./anchor-treasureBox"),Webs=function(e){this.flash=null,this.token=null,this.userId=null,this.login=!1,this.weblg=!1,this.effect=!0,this.QQGame=!1,this.anchorId=null,this.intervals=null,this.sendTsg="ALL",this.sendUserId=null,this.map=new Map,this.cache=new Map,this.queue=new Map,this.events=new Map,this.modules=new Map,this.userList=new Map,this.roomNumber=null,this.newSendGiftID="",this.url=e||"",this.isIE=!!window.ActiveXObject,this.ie6=this.isIE&&!window.XMLHttpRequest,this.ie7=this.isIE&&!this.ie6&&!this.ie8,this.ie8=this.isIE&&!!document.documentMode};Webs.prototype={init:function(e){var s=this;s.addModules("lvs",lvs),s.addModules("pet",pet),s.addModules("swf",swf),s.addModules("song",song),s.addModules("face",face),s.addModules("list",list),s.addModules("hall",hall),s.addModules("chat",chat),s.addModules("gift",gift),s.addModules("login",login),s.addModules("guards",guards),s.addModules("anchor",anchor),s.addModules("setting",setting),s.addModules("backLoad",backLoad),s.addModules("treasureBox",treasureBox),s.cache.put("userInfo",!1),s.cache.put("anchorInfo",!1),s.roomNumber=e.roomNumber;for(var t=0;t<s.modules.size();t++){var n=s.modules.element(t);if(null!=n){var o=n.value;null!=o&&"function"==typeof o.init&&o.init({webs:s,params:s.params,data:e})}}window.onkeydown=function(e){var s;if(e||(e=window.event),s=document.all?e.keyCode:e.which,116==s){var t=Tools.getCookie(cons.LOCAL_TIMEREFRESH);if(null!=t){var n=(new Date).getTime();n-t<3e4?(e.keyCode=0,e.returnValue=!1):t=(new Date).getTime()}Tools.setCookie(cons.LOCAL_TIMEREFRESH,t,86400)}},window.onbeforeunload=function(){if(s.userId==s.anchorId&&null!=s.sock){var e="/rest/site/begins.mt",t=Tools.stringFormat("action=endShow&roomNumber={0}",s.roomNumber);$.ajax({url:e,type:"POST",data:t,cache:!1,dataType:"json",async:!1}).done(function(e){})}}},agents:function(){return this.QQGame},addModules:function(e,s){this.modules.put(e,s)},loading:function(e,s,t){lvs.mo();var n=this;n.token=s,n.userId=e,n.roomNumber=t;var o="/rest/checkToken/checkTokenRoles.mt",i=Tools.stringFormat("token={0}&userId={1}&roomNumber={2}",n.token,n.userId,n.roomNumber);$.ajax({type:"POST",url:o,data:i,cache:!1,dataType:"json",async:!1}).done(function(e){var s=!1,t=!1,o=!1,i=n.roomNumber;null!=e.data&&e.data.length>0&&e.data.forEach(function(e){if(null!=e&&"null"!=e)switch(e.msgid){case"ANCHORS_HANDINFO":s=!0;var a=jQuery.parseJSON(e.args);a.online&&(t=!0),n.anchorId=a.userId,i=a.roomNumber;break;case"FLASH_CONFIG":var a=jQuery.parseJSON(e.args);n.flash=a.flash,n.weblg=a.weblog,n.params=a.roomparams;break;case"USERS_HANDINFO":var a=jQuery.parseJSON(e.args);a.isAnchor&&(o=!0)}}),s&&(null!=n.userId&&n.userId>0&&(n.login=!0),n.doit({roomNumber:i,anchors:o,online:t,messag:e.resultMessage,status:e.resultStatus}),null!=e.data&&e.data.length>0&&e.data.forEach(function(e){if(null!=e&&"null"!=e){var s=n.events.get(e.msgid);null!=s&&s(e.args)}}))})},doit:function(e){var s=this;if(s.init(e),200==e.status){s.addEventListeners(),s.connect(),s.sendWelcome(),s.resconnect();for(var t=0;t<s.modules.size();t++){var n=s.modules.element(t);if(null!=n){var o=n.value;null!=o&&"function"==typeof o.socketAfter&&o.socketAfter({webs:s,params:s.params,data:e})}}}},weblog:function(msg){eval(this.weblg)&&console.log(msg)},restDoit:function(){this.connect(),this.sendWelcome()},standby:function(e){},close:function(e){swf.close(e)},petPlayAction:function(e){swf.petPlayAction(e)},loging:function(){login.showLoing()},liveClose:function(e){self.location="/html/100.html"},ntsRoom:function(){var e=this,s="/rest/site/nts.mt",t=Tools.stringFormat("roomNumber={0}",e.roomNumber);$.ajax({url:s,type:"POST",data:t,cache:!1,dataType:"json",async:!1}).done(function(e){200==e.resultStatus&&null!=e.data.roomNumber&&(self.location=Tools.stringFormat("/{0}",e.data.roomNumber))})},connect:function(){var e=this,s=UIF.handler.cache.get(cons.USER_SOCKETIO);s||(e.sock=io.connect(e.url+"/"+e.roomNumber),e.sock.on("connect",function(s){if(null!=s&&console.log(s),e.queue.size()>0){for(var t=new Array,n=0;n<e.queue.size();n++){var o=e.queue.element(0);t.push(o.key),e.sock.emit("msg",o.value)}for(var n=0;n<t.length;n++){var i=t[n];e.queue.remove(i)}}}),e.sock.on("msg",function(s){var t=s.args.length;if(s.length==t){var n=e.map.get(s.msgid);null!=n&&(e.map.remove(s.msgid),n(s.args));var n=e.events.get(s.msgid);null!=n&&n(s.args)}}),UIF.handler.cache.put(cons.USER_SOCKETIO,!0))},agentSocket:function(e){var s=this,t="/rest/checkToken/nsocket.mt",n=e;$.ajax({url:t,type:"POST",data:n,cache:!1,dataType:"json",async:!1}).done(function(e){200==e.resultStatus&&s.weblog("agent socket message success!")})},resconnect:function(){var e=this;if(e.userId==e.anchorId){setInterval(function(){e.socketio()},12e4)}},disconnect:function(){var e=this;null!=e.sock&&e.sock.disconnect(),e.sock=null},addEventListeners:function(){this.events.put("ANCHORS_STATUS",wcall.status),this.events.put("ANCHORS_CENSOR",wcall.censor),this.events.put("ANCHORS_NOTICE",wcall.anchorsNotice),this.events.put("ANCHORS_HANDINFO",wcall.anchorsHeadInfo),this.events.put("ANCHORS_LOCALNOTICE",wcall.anchorsLocalNotice),this.events.put("GUARD_LIST",wcall.guardList),this.events.put("MANUAL_NOTICE",wcall.comMsg),this.events.put("TASK_RESULTS",wcall.taskResults),this.events.put("USERS_HANDINFO",wcall.userInfo),this.events.put("USERS_VISITORS",wcall.userVisitors),this.events.put("USERS_SENDGIFTS",wcall.sendGifts),this.events.put("USERS_SENDUSERS",wcall.sendUsers),this.events.put("USERS_ROOMBANNED",wcall.roomBanned),this.events.put("USERS_ROOMKICKOUT",wcall.roomKickOut),this.events.put("USERS_ENTERSCARS",wcall.userEntersCars),this.events.put("USERS_SPEUPGRADES",wcall.upgrades),this.events.put("CHATP2P_MESSAGE",wcall.chatP2PMessage),this.events.put("CHATMSG_MESSAGE",wcall.chatMSGMessage),this.events.put("CHATPRV_MESSAGE",wcall.chatPRVMessage),this.events.put("CHATFLY_MESSAGE",wcall.chatFLYMessage),this.events.put("CHATAFF_MESSAGE",wcall.chatAFFMessage),this.events.put("ANCHOR_PK",wcall.anchorPK),this.events.put("ANCHORS_AUTOPET",wcall.initPetData),this.events.put("ANCHORS_PET",wcall.updatePetData),this.events.put("ANCHORS_PET_TELLBIRTH",wcall.petBirth),this.events.put("GUARDS_MESSAGE",wcall.guardsMessage),this.events.put("ROOM_RUNWAY",wcall.Runway)},sendMsg:function(e,s,t){var n=this;null==e&&(e={}),e.token=n.token,e.userId=n.userId,e.roomNumber=n.roomNumber;var o={events:"msg",tags:t,msgid:Tools.uuid(),args:encodeURI(JSON.stringify(e))};n.map.put(o.msgid,s),n.agents()?(null!=n.sock.id&&(o.suid=n.sock.id),o.nsp=n.roomNumber,n.agentSocket(o)):null!=n.sock&&null!=n.sock.emit?n.sock.emit("msg",o):n.queue.put(o.msgid,o)},sendWelcome:function(e,s){this.sendMsg(e,s,"welcome")},sendTaskInit:function(e,s){this.sendMsg(e,s,"taskinit")},sendTasking:function(e,s){this.sendMsg(e,s,"tasking")},follow:function(e,s){this.sendMsg(e,s,"follow")},countingStar:function(e,s){this.sendMsg(e,s,"countStar")},anchorInfo:function(e,s){this.sendMsg(e,s,"anchorInfo")},userInfo:function(e,s){this.sendMsg(e,s,"userInfo")},sendTaskGroups:function(e,s){this.sendMsg(e,s,"taskGroups")},taskDetails:function(e,s){e.flag="dosev",this.sendMsg(e,s,"tasking")},signin:function(e,s){e.flag="claim",this.sendMsg(e,s,"tasking")},claimeLookLive:function(e,s){e.flag="claim",this.sendMsg(e,s,"tasking")},deduction:function(e,s){this.sendMsg(e,s,"deduction")},saveSongs:function(e,s){this.sendMsg(e,s,"songsList")},delSongs:function(e,s){this.sendMsg(e,s,"delSongs")},songsListDetails:function(e,s){this.sendMsg(e,s,"songsDetails")},userOnline:function(e,s){this.sendMsg(e,s,"userOnline")},sendGuard:function(e,s){this.sendMsg(e,s,"guard")},sendAddGuard:function(e,s){this.sendMsg(e,s,"addGuard")},sendChatP2P:function(e,s){this.sendMsg(e,s,"chatp2p")},sendChatALL:function(e,s){this.sendMsg(e,s,"chatmsg")},sendChatFLY:function(e,s){this.sendMsg(e,s,"chatfly")},sendChatGLO:function(e,s){this.sendMsg(e,s,"chataff")},sendChatPRV:function(e,s){this.sendMsg(e,s,"chatprv")},weekNotice:function(e,s){this.sendMsg(e,s,"weekNotice")},cohesion:function(e,s){this.sendMsg(e,s,"cohesion")},sendNotice:function(e,s){this.sendMsg(e,s,"notice")},getNotice:function(e,s){this.sendMsg(e,s,"editNotice")},getRoomMan:function(e,s){this.sendMsg(e,s,"roomMan")},getUser:function(e,s){this.sendMsg(e,s,"editUser")},roomManagers:function(e,s){this.sendMsg(e,s,"addRoomMan")},chooseSong:function(e,s){this.sendMsg(e,s,"chooseSong")},blacks:function(e,s){this.sendMsg(e,s,"blacks")},upgrade:function(e,s){this.sendMsg(e,s,"upgrades")},sendUserGift:function(e,s){this.sendMsg(e,s,"sendUserGift")},censor:function(e,s){this.sendMsg(e,s,"censor")},sendPetInit:function(e,s){this.sendMsg(e,s,"anchorsAutoPet")},changePetName:function(e,s){this.sendMsg(e,s,"anchorsPetChangeName")},sendTreasureBoxInit:function(e,s){this.sendMsg(e,s,"chestBoxGet")},openTreasureBox:function(e,s){this.sendMsg(e,s,"openChestBox")},socketio:function(e,s){this.sendMsg(e,s,"socketio")}},module.exports=Webs}),define("map",[],function(e,s,t){var n=function(){this.elements=new Array};n.prototype={size:function(){return this.elements.length},isEmpty:function(){return this.elements.length<1},clear:function(){this.elements=new Array},put:function(e,s){this.containsKey(e)&&this.remove(e),this.elements.push({key:e,value:s})},remove:function(e){try{for(var s=0;this.elements.length;s++)if(this.elements[s].key==e)return this.elements.splice(s,1),!0}catch(e){return!1}return!1},get:function(e){try{for(var s=0;this.elements.length;s++)if(this.elements[s].key==e)return this.elements[s].value}catch(e){return null}},element:function(e){return e<0||e>=this.elements.length?null:this.elements[e]},containsKey:function(e){try{for(i=0;i<this.elements.length;i++)if(this.elements[i].key==e)return!0}catch(e){return!1}return!1},containsValue:function(e){try{for(i=0;i<this.elements.length;i++)if(this.elements[i].value==e)return!0}catch(e){return!1}return!1},values:function(){var e=new Array;for(i=0;i<this.elements.length;i++)e.push(this.elements[i].value);return e},keys:function(){var e=new Array;for(i=0;i<this.elements.length;i++)e.push(this.elements[i].key);return e}},t.exports=n}),define("cons",[],function(e,s,t){t.exports={USER_SOCKETIO:"user_socketio",USER_HEADIMAG:"user_headimag",USER_HEADROLES:"user_headroles",USER_HEADINFOS:"user_headinfos",USER_SENDDANMU:"user_sendDanmu",USER_SENDNICE:"user_sendNice",GIFT_ENTERCARS:"gift_enterCars",GIFT_TRANSTIME:"gift_transTime",GIFT_TIMENUMBERS:"gift_timeNumbers",GIFT_TIMEUUIDS:"gift_timeuuids",GIFT_TIMEGIFTIDS:"gift_timeGiftIds",ANCHOR_HEADINFOS:"anchor_headinfos",GIFT_TIMEGNUMBERS:"gift_timeGNumbers",LOCAL_TIMEREFRESH:"loacl_timeRefresh",LOCAL_TIMESENDMSG:"loacl_timeSendMsg",LOCAL_TIMENICES:"loacl_timeNices"}});